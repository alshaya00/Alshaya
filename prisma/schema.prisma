// Prisma schema for آل شايع Family Tree Application
// Enhanced with change history, audit trail, and permissions

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./family.db"
}

// ============================================
// CORE MODELS
// ============================================

model FamilyMember {
  id                    String   @id // P001, P002, etc.
  firstName             String   // الاسم
  fatherName            String?  // اسم الأب
  grandfatherName       String?  // اسم الجد
  greatGrandfatherName  String?  // اسم الجد الثاني
  familyName            String   @default("آل شايع")

  // Relationship
  fatherId              String?  // Father_ID reference
  father                FamilyMember?  @relation("ParentChild", fields: [fatherId], references: [id])
  children              FamilyMember[] @relation("ParentChild")

  // Personal info
  gender                String   // Male or Female
  birthYear             Int?     // سنة الميلاد
  deathYear             Int?     // سنة الوفاة
  sonsCount             Int      @default(0) // عدد الأبناء
  daughtersCount        Int      @default(0) // عدد البنات

  // Calculated/Display fields
  generation            Int      @default(1) // الجيل
  branch                String?  // الفرع (الأصل, الفرع 1, etc.)
  fullNameAr            String?  // الاسم الكامل بالعربي
  fullNameEn            String?  // Full name in English

  // Lineage Identification (Gen 2/Gen 3 branch tracking)
  lineageBranchId       String?  // ID of Gen 2 ancestor (main branch founder)
  lineageBranchName     String?  // Name of Gen 2 ancestor for display
  subBranchId           String?  // ID of Gen 3 ancestor (sub-branch founder)
  subBranchName         String?  // Name of Gen 3 ancestor for display
  lineagePath           String?  // JSON array of ancestor IDs from root to parent

  // Contact info
  phone                 String?
  city                  String?
  status                String   @default("Living") // Living, Deceased
  photoUrl              String?
  biography             String?
  occupation            String?
  email                 String?

  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  createdBy             String?  // Admin who created
  lastModifiedBy        String?  // Admin who last modified
  version               Int      @default(1) // Version number for optimistic locking

  // Relations
  changeHistory         ChangeHistory[]
  duplicateOf           DuplicateFlag[] @relation("DuplicateSource")
  duplicatedBy          DuplicateFlag[] @relation("DuplicateTarget")
  photos                MemberPhoto[]

  @@index([generation])
  @@index([branch])
  @@index([gender])
  @@index([fatherId])
  @@index([status])
  @@index([firstName])
  @@index([lineageBranchId])
  @@index([subBranchId])
}

// ============================================
// AUDIT & HISTORY MODELS
// ============================================

model ChangeHistory {
  id              String   @id @default(cuid())
  memberId        String
  member          FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // What changed
  fieldName       String   // Field that was changed
  oldValue        String?  // Previous value (JSON for complex fields)
  newValue        String?  // New value (JSON for complex fields)
  changeType      String   // CREATE, UPDATE, DELETE, PARENT_CHANGE, RESTORE

  // Who and when
  changedBy       String   // Admin ID who made the change
  changedByName   String   // Admin name for display
  changedAt       DateTime @default(now())

  // For grouping related changes (batch edits)
  batchId         String?  // Groups changes made together

  // Snapshot for rollback
  fullSnapshot    String?  // JSON snapshot of entire member state before change

  // Additional context
  reason          String?  // Optional reason for the change
  ipAddress       String?  // For security audit

  @@index([memberId])
  @@index([changedAt])
  @@index([changedBy])
  @@index([batchId])
  @@index([changeType])
}

model Snapshot {
  id              String   @id @default(cuid())
  name            String   // User-provided name for the snapshot
  description     String?  // Optional description

  // Full tree data
  treeData        String   // JSON of entire family tree at this point
  memberCount     Int      // Number of members at this point

  // Metadata
  createdBy       String   // Admin who created snapshot
  createdByName   String   // Admin name
  createdAt       DateTime @default(now())

  // Snapshot type
  snapshotType    String   @default("MANUAL") // MANUAL, AUTO_BACKUP, PRE_IMPORT

  @@index([createdAt])
  @@index([snapshotType])
}

// ============================================
// DUPLICATE DETECTION
// ============================================

model DuplicateFlag {
  id              String   @id @default(cuid())

  // The two members flagged as potential duplicates
  sourceMemberId  String
  sourceMember    FamilyMember @relation("DuplicateSource", fields: [sourceMemberId], references: [id], onDelete: Cascade)
  targetMemberId  String
  targetMember    FamilyMember @relation("DuplicateTarget", fields: [targetMemberId], references: [id], onDelete: Cascade)

  // Similarity details
  matchScore      Float    // 0-100 confidence score
  matchReasons    String   // JSON array of why they might be duplicates

  // Resolution
  status          String   @default("PENDING") // PENDING, CONFIRMED_DUPLICATE, NOT_DUPLICATE, MERGED
  resolvedBy      String?  // Admin who resolved
  resolvedAt      DateTime?
  resolution      String?  // What action was taken

  // Metadata
  detectedAt      DateTime @default(now())
  detectedBy      String   @default("SYSTEM") // SYSTEM or admin ID

  @@unique([sourceMemberId, targetMemberId])
  @@index([status])
  @@index([matchScore])
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  passwordHash    String

  // Profile
  nameArabic      String
  nameEnglish     String?
  phone           String?
  avatarUrl       String?

  // Role & Status
  role            String   @default("MEMBER") // SUPER_ADMIN, ADMIN, BRANCH_LEADER, MEMBER, GUEST
  status          String   @default("PENDING") // PENDING, ACTIVE, DISABLED

  // Link to family member profile (optional - user can be linked to their family member record)
  linkedMemberId  String?

  // For branch leaders - which branch they manage
  assignedBranch  String?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastLoginAt     DateTime?
  emailVerifiedAt DateTime?

  // Relations
  sessions        Session[]
  invitesSent     Invite[] @relation("InviteSender")
  inviteUsed      Invite?  @relation("InviteUsed")
  accessRequest   AccessRequest?
  activityLogs    ActivityLog[]
  notifications   Notification[]

  @@index([email])
  @@index([role])
  @@index([status])
  @@index([linkedMemberId])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  token        String   @unique
  expiresAt    DateTime

  // Session options
  rememberMe   Boolean  @default(false)

  // Device info for security
  ipAddress    String?
  userAgent    String?
  deviceName   String?  // "Chrome on Windows", etc.

  createdAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model Invite {
  id           String   @id @default(cuid())
  code         String   @unique
  email        String

  // What role and branch to assign
  role         String   @default("MEMBER")
  branch       String?  // For branch leader invites

  // Who sent it
  sentById     String
  sentBy       User     @relation("InviteSender", fields: [sentById], references: [id])

  // Usage tracking
  expiresAt    DateTime
  usedAt       DateTime?
  usedById     String?  @unique
  usedBy       User?    @relation("InviteUsed", fields: [usedById], references: [id])

  // Personal message
  message      String?

  createdAt    DateTime @default(now())

  @@index([code])
  @@index([email])
  @@index([sentById])
}

model AccessRequest {
  id              String   @id @default(cuid())

  // Request details
  email           String
  nameArabic      String
  nameEnglish     String?
  phone           String?

  // How they claim to be related
  claimedRelation String   // "Son of محمد", "Daughter of أحمد", etc.
  relatedMemberId String?  // ID of the family member they claim relation to
  relationshipType String? // CHILD, SPOUSE, SIBLING, etc.

  // Their message
  message         String?

  // Review status
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED, MORE_INFO
  reviewedById    String?
  reviewedAt      DateTime?
  reviewNote      String?

  // If approved, link to created user
  userId          String?  @unique
  user            User?    @relation(fields: [userId], references: [id])

  // Assigned role on approval
  approvedRole    String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([email])
  @@index([status])
}

model PasswordReset {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([token])
  @@index([email])
}

model EmailVerification {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([token])
  @@index([email])
}

// ============================================
// PERMISSION MATRIX (Fully Configurable)
// ============================================

model PermissionMatrix {
  id              String   @id @default("default")

  // JSON object storing all permissions by role
  // Structure: { "ROLE": { "permission_key": true/false, ... }, ... }
  permissions     String   @default("{}")

  updatedAt       DateTime @updatedAt
  updatedBy       String?
}

// Individual permission overrides for specific users
model UserPermissionOverride {
  id              String   @id @default(cuid())
  userId          String
  permissionKey   String
  allowed         Boolean

  // Who set this override
  setBy           String
  setAt           DateTime @default(now())
  reason          String?

  @@unique([userId, permissionKey])
  @@index([userId])
}

// ============================================
// SITE SETTINGS
// ============================================

model SiteSettings {
  id                      String  @id @default("default")

  // Branding
  familyNameArabic        String  @default("آل شايع")
  familyNameEnglish       String  @default("Al-Shaye")
  taglineArabic           String  @default("نحفظ إرثنا، نربط أجيالنا")
  taglineEnglish          String  @default("Preserving Our Legacy, Connecting Generations")
  logoUrl                 String?

  // General settings
  defaultLanguage         String  @default("ar")
  sessionDurationDays     Int     @default(7)
  rememberMeDurationDays  Int     @default(30)

  // Registration settings
  allowSelfRegistration   Boolean @default(true)
  requireEmailVerification Boolean @default(false)
  requireApprovalForRegistration Boolean @default(true)

  // Security settings
  maxLoginAttempts        Int     @default(5)
  lockoutDurationMinutes  Int     @default(15)
  require2FAForAdmins     Boolean @default(false)
  minPasswordLength       Int     @default(8)

  // Guest access settings
  allowGuestPreview       Boolean @default(true)  // Show simplified tree to guests
  guestPreviewMemberCount Int     @default(20)    // How many members guests can see

  updatedAt               DateTime @updatedAt
}

model PrivacySettings {
  id                      String  @id @default("default")

  // Profile visibility by role (JSON: { "GUEST": false, "MEMBER": true, ... })
  profileVisibility       String  @default("{\"GUEST\":false,\"MEMBER\":true,\"BRANCH_LEADER\":true,\"ADMIN\":true,\"SUPER_ADMIN\":true}")

  // Contact info visibility
  showPhoneToRoles        String  @default("[\"ADMIN\",\"SUPER_ADMIN\"]")
  showEmailToRoles        String  @default("[\"ADMIN\",\"SUPER_ADMIN\"]")

  // Personal info visibility
  showBirthYearToRoles    String  @default("[\"MEMBER\",\"BRANCH_LEADER\",\"ADMIN\",\"SUPER_ADMIN\"]")
  showAgeForLiving        Boolean @default(false)
  showOccupation          Boolean @default(true)
  showCity                Boolean @default(true)
  showBiography           Boolean @default(true)

  // Photo visibility
  showPhotosToRoles       String  @default("[\"MEMBER\",\"BRANCH_LEADER\",\"ADMIN\",\"SUPER_ADMIN\"]")

  // Deceased members
  showDeathYear           Boolean @default(true)
  showFullDeathDate       Boolean @default(false)

  updatedAt               DateTime @updatedAt
}

// ============================================
// ACTIVITY & NOTIFICATIONS
// ============================================

model ActivityLog {
  id          String   @id @default(cuid())

  // Who did it
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userEmail   String?  // Store email in case user is deleted
  userName    String?  // Store name in case user is deleted

  // What they did
  action      String   // LOGIN, LOGOUT, VIEW_MEMBER, EDIT_MEMBER, CREATE_MEMBER, etc.
  category    String   // AUTH, MEMBER, USER, SETTINGS, EXPORT, etc.

  // Target of the action
  targetType  String?  // USER, MEMBER, SETTINGS, etc.
  targetId    String?
  targetName  String?  // Human readable name of target

  // Additional details
  details     String?  // JSON with extra context

  // Security info
  ipAddress   String?
  userAgent   String?

  // Result
  success     Boolean  @default(true)
  errorMessage String?

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([category])
  @@index([createdAt])
  @@index([targetType, targetId])
}

model Notification {
  id          String   @id @default(cuid())

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification content
  type        String   // WELCOME, ACCESS_APPROVED, NEW_MEMBER, EDIT_SUGGESTION, etc.
  titleAr     String
  titleEn     String
  messageAr   String
  messageEn   String

  // Link to related content
  linkUrl     String?
  linkType    String?  // MEMBER, USER, REQUEST, etc.
  linkId      String?

  // Status
  read        Boolean  @default(false)
  readAt      DateTime?

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

// ============================================
// LEGACY ADMIN MODEL (Deprecated - migrate to User)
// ============================================

model Admin {
  id              String   @id @default(cuid())
  name            String
  email           String   @unique
  accessCode      String   // Hashed access code

  // Permissions
  role            String   @default("EDITOR") // SUPER_ADMIN, ADMIN, EDITOR, VIEWER
  permissions     String   // JSON array of specific permissions

  // Status
  isActive        Boolean  @default(true)
  lastLoginAt     DateTime?

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?  // Admin who created this admin

  // Sessions
  sessions        AdminSession[]

  // Migration flag
  migratedToUserId String? // If migrated to new User model

  @@index([email])
  @@index([isActive])
}

model AdminSession {
  id              String   @id @default(cuid())
  adminId         String
  admin           Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)

  // Session data
  token           String   @unique
  expiresAt       DateTime

  // Device info
  userAgent       String?
  ipAddress       String?

  // Metadata
  createdAt       DateTime @default(now())
  lastActivityAt  DateTime @default(now())

  @@index([token])
  @@index([adminId])
  @@index([expiresAt])
}

// ============================================
// SEARCH HISTORY
// ============================================

model SearchHistory {
  id              String   @id @default(cuid())

  // Who searched
  userId          String?  // null for guest/anonymous searches
  sessionId       String?  // For tracking guest searches

  // What was searched
  query           String   // The search query
  searchType      String   @default("member") // member, branch, generation, global
  filters         String?  // JSON of applied filters

  // Results
  resultsCount    Int      @default(0)
  clickedResultId String?  // If user clicked on a result

  // Context
  ipAddress       String?
  userAgent       String?

  // Metadata
  searchedAt      DateTime @default(now())

  @@index([userId])
  @@index([query])
  @@index([searchedAt])
  @@index([searchType])
}

// ============================================
// IMPORT/EXPORT TRACKING
// ============================================

model ImportJob {
  id              String   @id @default(cuid())

  // Import details
  fileName        String
  fileType        String   // JSON, CSV, EXCEL
  totalRecords    Int

  // Progress
  status          String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, CANCELLED
  processedCount  Int      @default(0)
  successCount    Int      @default(0)
  errorCount      Int      @default(0)

  // Conflict handling
  conflictCount   Int      @default(0)
  conflicts       String?  // JSON array of conflicts
  conflictResolutions String? // JSON of how conflicts were resolved

  // Results
  importedIds     String?  // JSON array of imported member IDs
  errorLog        String?  // JSON array of errors

  // Metadata
  importedBy      String
  importedByName  String
  startedAt       DateTime @default(now())
  completedAt     DateTime?

  // Rollback support
  snapshotId      String?  // Snapshot created before import

  @@index([status])
  @@index([importedBy])
}

model ExportJob {
  id              String   @id @default(cuid())

  // Export details
  format          String   // JSON, CSV, EXCEL, PDF
  fileName        String

  // What was exported
  memberCount     Int
  fieldsIncluded  String   // JSON array of fields exported
  filters         String?  // JSON of filters applied

  // Metadata
  exportedBy      String
  exportedByName  String
  exportedAt      DateTime @default(now())

  // File info
  fileSize        Int?     // bytes
  downloadUrl     String?  // Temporary download URL

  @@index([exportedBy])
  @@index([exportedAt])
}

// ============================================
// PENDING MEMBERS (for branch entry system)
// ============================================

model PendingMember {
  id                    String   @id @default(cuid())

  // Same fields as FamilyMember
  firstName             String
  fatherName            String?
  grandfatherName       String?
  greatGrandfatherName  String?
  familyName            String   @default("آل شايع")
  proposedFatherId      String?
  gender                String
  birthYear             Int?
  generation            Int      @default(1)
  branch                String?
  fullNameAr            String?
  fullNameEn            String?
  phone                 String?
  city                  String?
  status                String   @default("Living")
  occupation            String?
  email                 String?

  // Submission info
  submittedVia          String?  // Branch token or direct
  submittedAt           DateTime @default(now())

  // Review status
  reviewStatus          String   @default("PENDING") // PENDING, APPROVED, REJECTED
  reviewedBy            String?
  reviewedAt            DateTime?
  reviewNotes           String?

  // If approved, the created member ID
  approvedMemberId      String?

  @@index([reviewStatus])
  @@index([branch])
}

// ============================================
// BRANCH ENTRY LINKS
// ============================================

model BranchEntryLink {
  id              String   @id @default(cuid())
  token           String   @unique

  // Branch info
  branchName      String
  branchHeadId    String   // The member who is the branch head
  branchHeadName  String

  // Access control
  isActive        Boolean  @default(true)
  expiresAt       DateTime?
  maxUses         Int?
  useCount        Int      @default(0)

  // Metadata
  createdBy       String
  createdAt       DateTime @default(now())

  @@index([token])
  @@index([isActive])
}

// ============================================
// API SERVICE CONFIGURATION
// ============================================

model ApiServiceConfig {
  id                      String  @id @default("default")

  // Email Provider Configuration
  emailProvider           String  @default("none") // resend, sendgrid, mailgun, smtp, none
  emailApiKey             String? // Encrypted API key
  emailFromAddress        String?
  emailFromName           String?

  // SMTP Configuration (when provider is smtp)
  smtpHost                String?
  smtpPort                Int?
  smtpUser                String?
  smtpPassword            String? // Encrypted
  smtpSecure              Boolean @default(true)

  // OTP/SMS Provider Configuration
  otpProvider             String  @default("none") // twilio, vonage, messagebird, none
  otpApiKey               String? // Encrypted
  otpApiSecret            String? // Encrypted
  otpFromNumber           String?

  // General Settings
  enableEmailNotifications Boolean @default(false)
  enableSMSNotifications   Boolean @default(false)
  testMode                 Boolean @default(true) // If true, don't actually send emails/SMS

  // Metadata
  updatedAt               DateTime @updatedAt
  updatedBy               String?
}

// ============================================
// EMAIL LOGS
// ============================================

model EmailLog {
  id              String   @id @default(cuid())

  // Email details
  to              String
  from            String
  subject         String
  templateName    String?
  templateData    String?  // JSON

  // Status
  status          String   @default("PENDING") // PENDING, SENT, FAILED, BOUNCED
  provider        String
  providerMessageId String?
  errorMessage    String?

  // Metadata
  createdAt       DateTime @default(now())
  sentAt          DateTime?

  @@index([to])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// EMAIL BROADCASTS (Family Meeting Invites, Updates, Reminders)
// ============================================

model Broadcast {
  id              String   @id @default(cuid())

  // Content
  titleAr         String   // Arabic title
  titleEn         String?  // English title (optional)
  contentAr       String   // Arabic content (HTML)
  contentEn       String?  // English content (HTML)

  // Type of broadcast
  type            String   @default("ANNOUNCEMENT") // MEETING, ANNOUNCEMENT, REMINDER, UPDATE

  // Meeting-specific fields
  meetingDate     DateTime?  // Date and time of the meeting
  meetingLocation String?    // Physical or virtual location
  meetingUrl      String?    // Zoom/Teams/Google Meet link
  rsvpRequired    Boolean    @default(false)
  rsvpDeadline    DateTime?  // Deadline to respond

  // Targeting
  targetAudience  String   @default("ALL") // ALL, BRANCH, GENERATION, CUSTOM
  targetBranch    String?  // Specific branch if targeting branch
  targetGeneration Int?    // Specific generation if targeting generation
  targetMemberIds String?  // JSON array of specific member IDs if custom

  // Scheduling
  status          String   @default("DRAFT") // DRAFT, SCHEDULED, SENDING, SENT, CANCELLED
  scheduledAt     DateTime? // When to send (null = send immediately)
  sentAt          DateTime? // When actually sent

  // Statistics
  totalRecipients Int      @default(0)
  sentCount       Int      @default(0)
  failedCount     Int      @default(0)
  openCount       Int      @default(0)
  rsvpYesCount    Int      @default(0)
  rsvpNoCount     Int      @default(0)
  rsvpMaybeCount  Int      @default(0)

  // Metadata
  createdBy       String   // User ID who created
  createdByName   String   // User name for display
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  recipients      BroadcastRecipient[]

  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([scheduledAt])
}

model BroadcastRecipient {
  id              String   @id @default(cuid())

  broadcastId     String
  broadcast       Broadcast @relation(fields: [broadcastId], references: [id], onDelete: Cascade)

  // Recipient info
  memberId        String?  // Family member ID (if linked)
  memberName      String   // Name for display
  email           String   // Email address

  // Delivery status
  status          String   @default("PENDING") // PENDING, SENT, FAILED, BOUNCED
  sentAt          DateTime?
  errorMessage    String?

  // Tracking
  openedAt        DateTime?  // When email was opened
  clickedAt       DateTime?  // When any link was clicked

  // RSVP response (for meeting broadcasts)
  rsvpResponse    String?    // YES, NO, MAYBE
  rsvpRespondedAt DateTime?
  rsvpNote        String?    // Optional note with RSVP

  @@unique([broadcastId, email])
  @@index([broadcastId])
  @@index([status])
  @@index([memberId])
}

// ============================================
// SMS/OTP LOGS
// ============================================

model SmsLog {
  id              String   @id @default(cuid())

  // SMS details
  to              String
  from            String
  message         String
  type            String   @default("OTP") // OTP, NOTIFICATION

  // Status
  status          String   @default("PENDING") // PENDING, SENT, FAILED, DELIVERED
  provider        String
  providerMessageId String?
  errorMessage    String?

  // Metadata
  createdAt       DateTime @default(now())
  sentAt          DateTime?

  @@index([to])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// SCHEDULED JOBS (for backups, cleanup, etc.)
// ============================================

model ScheduledJob {
  id              String   @id @default(cuid())
  name            String   @unique
  description     String?

  // Schedule (cron expression)
  cronExpression  String
  timezone        String   @default("Asia/Riyadh")

  // Job configuration
  jobType         String   // BACKUP, CLEANUP, EMAIL_DIGEST, etc.
  jobConfig       String?  // JSON configuration

  // Status
  isEnabled       Boolean  @default(true)
  lastRunAt       DateTime?
  lastRunStatus   String?  // SUCCESS, FAILED, RUNNING
  lastRunDuration Int?     // milliseconds
  lastRunError    String?
  nextRunAt       DateTime?

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isEnabled])
  @@index([nextRunAt])
}

// ============================================
// IMAGE MANAGEMENT (Upload & Approval System)
// ============================================

model PendingImage {
  id              String   @id @default(cuid())

  // Image data
  imageData       String   // Base64 encoded image
  thumbnailData   String?  // Smaller version for preview

  // Categorization
  category        String   @default("memory") // profile, memory, document, historical
  title           String?  // User-provided title
  titleAr         String?  // Arabic title
  caption         String?  // Description/story
  captionAr       String?  // Arabic caption
  year            Int?     // Year the photo was taken (for timeline)

  // Who/what is in the photo
  memberId        String?  // Primary member in photo (optional)
  memberName      String?  // Member name for display
  taggedMemberIds String?  // JSON array of tagged member IDs

  // Submission info
  uploadedBy      String?  // User ID (null for guest uploads)
  uploadedByName  String   // Name of uploader
  uploadedByEmail String?  // Email for guest uploads
  uploadedAt      DateTime @default(now())
  ipAddress       String?  // For security

  // Review status
  reviewStatus    String   @default("PENDING") // PENDING, APPROVED, REJECTED
  reviewedBy      String?  // Admin who reviewed
  reviewedByName  String?
  reviewedAt      DateTime?
  reviewNotes     String?  // Reason for rejection or notes

  // If approved, link to created MemberPhoto
  approvedPhotoId String?

  @@index([reviewStatus])
  @@index([category])
  @@index([memberId])
  @@index([uploadedBy])
  @@index([uploadedAt])
}

model MemberPhoto {
  id              String   @id @default(cuid())

  // Image data
  imageData       String   // Base64 encoded image
  thumbnailData   String?  // Smaller version for gallery view

  // Categorization
  category        String   @default("memory") // profile, memory, document, historical
  title           String?
  titleAr         String?
  caption         String?
  captionAr       String?
  year            Int?     // For timeline sorting

  // Primary member (whose gallery this appears in)
  memberId        String?
  member          FamilyMember? @relation(fields: [memberId], references: [id], onDelete: SetNull)

  // Tagged members (for group photos)
  taggedMemberIds String?  // JSON array of member IDs

  // For family album (photos not tied to specific member)
  isFamilyAlbum   Boolean  @default(false)

  // Contribution tracking
  uploadedBy      String?  // User ID
  uploadedByName  String
  originalPendingId String? // Reference to original pending image

  // Display settings
  isProfilePhoto  Boolean  @default(false) // Primary profile photo for member
  displayOrder    Int      @default(0) // For gallery ordering
  isPublic        Boolean  @default(true) // Visible to all roles

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([memberId])
  @@index([category])
  @@index([isFamilyAlbum])
  @@index([year])
  @@index([uploadedBy])
  @@index([isProfilePhoto])
}
